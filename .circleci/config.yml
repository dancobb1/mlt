version: 2
jobs:
  build:
    machine: true
    environment:
      # CHANGE_MINIKUBE_NONE_USER: true
      KUBECONFIG: /home/circleci/.kube/config
    working_directory: ~/repo
    # gets around pyenv with circleci: https://discuss.circleci.com/t/testing-in-different-environments/450/12
    dependencies:
      override:
        - sudo pip install tox tox-pyenv
        - pyenv local 2.7.12 3.5.2
    steps:
      - checkout

      - run:
          name: Installing test/lint dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -yq --no-install-recommends --fix-missing \
                curl \
                git \
                make \
                python \
                python-dev \
                python-pip \
                python-setuptools \
                python3 \
                python3-dev \
                python3-pip \
                python3-setuptools \
                python3-wheel \
                tar

      # - run:
      #     name: lint tests
      #     command: |
      #       make lint
      
      # - run:
      #     name: Run unit tests
      #     command: |
      #       make test

      - run:
          name: Installing docker dependencies
          command: |
            set -x
            VER="17.03.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            sudo mv /tmp/docker/* /usr/bin
            curl -L https://github.com/docker/compose/releases/download/1.16.0/docker-compose-`uname -s`-`uname -m` | sudo tee -a /usr/local/bin/docker-compose > /dev/null
            sudo chmod +x /usr/local/bin/docker-compose

      # - setup_remote_docker:
      #     docker_layer_caching: true

      # - run:
      #     name: Setting up hyperkube
      #     command: |
      #       # docker will fail with `shim error: json: cannot unmarshal object into Go value of type []string` without this
      #       sudo service docker restart

            
            
      - run:
          name: Run e2e tests
          command: |
            # docker will fail with `shim error: json: cannot unmarshal object into Go value of type []string` without this
            sudo service docker restart
            # in order for other things to see mounts created by kubelet, need it to be shared
            sudo mkdir -p /var/lib/kubelet
            sudo mount -o bind /var/lib/kubelet /var/lib/kubelet
            sudo mount --make-shared /var/lib/kubelet

            make test-e2e
